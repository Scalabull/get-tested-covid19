version: 2.1
jobs:
  terraform:
    docker:
      - image: hashicorp/terraform:light
    steps:
      - checkout
      - run:
         name: terraform-init
         command: OBJECT_KEY=dev ./util/terraform/terraform_init.sh
      - run:
         name: terraform-plan
         command: terraform plan
     
  build:
    docker:
      - image: node:12-alpine
    steps:
      - checkout
      - run:
          name: yarn-install
          command: yarn install --production
      - run:
          name: npm-build
          command: CI=false npm run build
#       - run:
#           name: npm-test
#           command: npm run test
# TODO: setup caching
workflows:
  version: 2
  terraform_and_build:
    jobs:
      - terraform
      - build